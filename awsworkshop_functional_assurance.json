{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "AWS CloudFormation Template to setup Codepipeline for awswrkshp functional Assurance testing",
	"Resources": {
		"wrkshpcodebuildRoleFuncAssu": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"codebuild.amazonaws.com",
									"codedeploy.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "workshopcodebuildpolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": "*",
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"awswrkshpfunctionalassuranceApi": {
			"DependsOn": [
				"wrkshpcodebuildRoleFuncAssu"
			],
			"Type": "AWS::CodeBuild::Project",
			"Properties": {
				"Artifacts": {
					"Location": {
						"Fn::ImportValue": "bucketname"
					},
					"Name": "/",
					"Type": "S3"
				},
				"VpcConfig": {
					"SecurityGroupIds": [
						{
							"Fn::ImportValue": "securitygroup"
						}
					],
					"Subnets": [
						{
							"Fn::ImportValue": "wrkshpPrivateSubnet"
						}
					],
					"VpcId": {
						"Fn::ImportValue": "wrkshpVPC"
					}
				},
				"Description": "This build is for Functional Assurance API created through cfn",
				"Environment": {
					"ComputeType": "BUILD_GENERAL1_MEDIUM",
					"Image": "aws/codebuild/standard:4.0",
					"PrivilegedMode": "True",
					"Type": "LINUX_CONTAINER"
				},
				"LogsConfig": {
					"CloudWatchLogs": {
						"Status": "ENABLED"
					},
					"S3Logs": {
						"Status": "DISABLED"
					}
				},
				"Name": "awswrkshp_functional_assurance_api",
				"QueuedTimeoutInMinutes": 480,
				"ServiceRole": {
					"Ref": "wrkshpcodebuildRoleFuncAssu"
				},
				"Source": {
					"Location": {
						"Fn::ImportValue": "wrkshpfunctionalAssuranceRepo"
					},
					"Type": "CODECOMMIT",
					"BuildSpec": "funcassur_stage2_api_buildspec.yml",
					"GitCloneDepth": 1
				},
				"SourceVersion": "refs/heads/master",
				"TimeoutInMinutes": 60
			}
		},
		"awswrkshpfunctionalassuranceUi": {
			"DependsOn": [
				"wrkshpcodebuildRoleFuncAssu"
			],
			"Type": "AWS::CodeBuild::Project",
			"Properties": {
				"Artifacts": {
					"Location": {
						"Fn::ImportValue": "bucketname"
					},
					"Name": "/",
					"Type": "S3"
				},
				"VpcConfig": {
					"SecurityGroupIds": [
						{
							"Fn::ImportValue": "securitygroup"
						}
					],
					"Subnets": [
						{
							"Fn::ImportValue": "wrkshpPrivateSubnet"
						}
					],
					"VpcId": {
						"Fn::ImportValue": "wrkshpVPC"
					}
				},
				"Description": "This build is for Functional Assurance UI created through cfn",
				"Environment": {
					"ComputeType": "BUILD_GENERAL1_MEDIUM",
					"Image": "aws/codebuild/standard:4.0",
					"PrivilegedMode": "True",
					"Type": "LINUX_CONTAINER"
				},
				"LogsConfig": {
					"CloudWatchLogs": {
						"Status": "ENABLED"
					},
					"S3Logs": {
						"Status": "DISABLED"
					}
				},
				"Name": "awswrkshp_functional_assurance_ui",
				"QueuedTimeoutInMinutes": 480,
				"ServiceRole": {
					"Ref": "wrkshpcodebuildRoleFuncAssu"
				},
				"Source": {
					"Location": {
						"Fn::ImportValue": "wrkshpfunctionalAssuranceRepo"
					},
					"Type": "CODECOMMIT",
					"BuildSpec": "funcassur_stage2_ui_buildspec.yml",
					"GitCloneDepth": 1
				},
				"SourceVersion": "refs/heads/master",
				"TimeoutInMinutes": 60
			}
		},
		"awswrkshpfunctionalassuranceRwd": {
			"DependsOn": [
				"wrkshpcodebuildRoleFuncAssu"
			],
			"Type": "AWS::CodeBuild::Project",
			"Properties": {
				"Artifacts": {
					"Location": {
						"Fn::ImportValue": "bucketname"
					},
					"Name": "/",
					"Type": "S3"
				},
				"VpcConfig": {
					"SecurityGroupIds": [
						{
							"Fn::ImportValue": "securitygroup"
						}
					],
					"Subnets": [
						{
							"Fn::ImportValue": "wrkshpPrivateSubnet"
						}
					],
					"VpcId": {
						"Fn::ImportValue": "wrkshpVPC"
					}
				},
				"Description": "This build is for Functional Assurance RWD created through cfn",
				"Environment": {
					"ComputeType": "BUILD_GENERAL1_MEDIUM",
					"Image": "aws/codebuild/standard:4.0",
					"PrivilegedMode": "True",
					"Type": "LINUX_CONTAINER"
				},
				"LogsConfig": {
					"CloudWatchLogs": {
						"Status": "ENABLED"
					},
					"S3Logs": {
						"Status": "DISABLED"
					}
				},
				"Name": "awswrkshp_functional_assurance_ui_rwd",
				"QueuedTimeoutInMinutes": 480,
				"ServiceRole": {
					"Ref": "wrkshpcodebuildRoleFuncAssu"
				},
				"Source": {
					"Location": {
						"Fn::ImportValue": "wrkshpfunctionalAssuranceRepo"
					},
					"Type": "CODECOMMIT",
					"BuildSpec": "funcassur_stage2_rwd_buildspec.yml",
					"GitCloneDepth": 1
				},
				"SourceVersion": "refs/heads/master",
				"TimeoutInMinutes": 60
			}
		},
		"wrkshpcodepipelineroleFuncAssu": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"codepipeline.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"Policies": [
					{
						"PolicyName": "codepipelinepolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": "*",
									"Resource": "*"
								}
							]
						}
					}
				]
			}
		},
		"CodePipeline": {
			"DependsOn": [
				"wrkshpcodepipelineroleFuncAssu"
			],
			"Type": "AWS::CodePipeline::Pipeline",
			"Properties": {
				"ArtifactStore": {
					"Location": {
						"Fn::ImportValue": "bucketname"
					},
					"Type": "S3"
				},
				"Name": "codepipeline_Functional_Assurance",
				"RoleArn": {
					"Fn::GetAtt": [
						"wrkshpcodepipelineroleFuncAssu",
						"Arn"
					]
				},
				"Stages": [
					{
						"Actions": [
							{
								"OutputArtifacts": [
									{
										"Name": "SourceArtifact"
									}
								],
								"InputArtifacts": [],
								"Configuration": {
									"RepositoryName": "awswrkshp-functional-assurance",
									"BranchName": "master",
									"PollForSourceChanges": "true"
								},
								"RunOrder": 1,
								"Namespace": "SourceVariables",
								"ActionTypeId": {
									"Category": "Source",
									"Owner": "AWS",
									"Provider": "CodeCommit",
									"Version": "1"
								},
								"Name": "Source_Functional"
							}
						],
						"Name": "SourceStage"
					},
					{
						"Actions": [
							{
								"OutputArtifacts": [
									{
										"Name": "BuildArtifact"
									}
								],
								"InputArtifacts": [
									{
										"Name": "SourceArtifact"
									}
								],
								"Configuration": {
									"ProjectName": {
										"Ref": "awswrkshpfunctionalassuranceApi"
									}
								},
								"RunOrder": 1,
								"Namespace": "BuildVariables",
								"ActionTypeId": {
									"Category": "Build",
									"Owner": "AWS",
									"Provider": "CodeBuild",
									"Version": "1"
								},
								"Name": "API_Test"
							},
							{
								"InputArtifacts": [
									{
										"Name": "SourceArtifact"
									}
								],
								"Configuration": {
									"ProjectName": {
										"Ref": "awswrkshpfunctionalassuranceUi"
									}
								},
								"RunOrder": 1,
								"ActionTypeId": {
									"Category": "Build",
									"Owner": "AWS",
									"Provider": "CodeBuild",
									"Version": "1"
								},
								"Name": "UI_Test"
							},
							{
								"InputArtifacts": [
									{
										"Name": "SourceArtifact"
									}
								],
								"Configuration": {
									"ProjectName": {
										"Ref": "awswrkshpfunctionalassuranceRwd"
									}
								},
								"RunOrder": 1,
								"ActionTypeId": {
									"Category": "Build",
									"Owner": "AWS",
									"Provider": "CodeBuild",
									"Version": "1"
								},
								"Name": "RWD_Test"
							}
						],
						"Name": "Build"
					}
				]
			}
		}
	}
}